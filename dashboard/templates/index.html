<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OS Sandbox Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 20px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chart-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .chart-card h3 {
            margin-bottom: 15px;
            color: #667eea;
        }

        canvas {
            max-height: 300px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #667eea;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .badge-malicious {
            background: #fee;
            color: #c00;
        }

        .badge-benign {
            background: #efe;
            color: #0a0;
        }

        .badge-buggy {
            background: #ffe;
            color: #c80;
        }

        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üîí OS Sandbox Analytics Dashboard</h1>
        <div style="text-align: center; margin-bottom: 1.5rem;">
            <a href="/analytics" style="text-decoration: none; color: #667eea; font-weight: bold; margin: 0 10px;">üìä
                Analytics & Intelligence</a>
            <span style="color: #ccc;">|</span>
            <a href="/evaluation" style="text-decoration: none; color: #667eea; font-weight: bold; margin: 0 10px;">‚öñÔ∏è
                Evaluation</a>
        </div>
        <div class="refresh-indicator">üîÑ Live (2s refresh)</div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-runs">-</div>
                <div class="stat-label">Total Executions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="violations">-</div>
                <div class="stat-label">Violations Detected</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avg-cpu">-%</div>
                <div class="stat-label">Avg CPU Usage</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avg-mem">- KB</div>
                <div class="stat-label">Avg Memory</div>
            </div>
        </div>

        <div class="chart-row">
            <div class="chart-card">
                <h3>üìä CPU Usage Timeline (Latest Run)</h3>
                <canvas id="cpuTimelineChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>üíæ Memory Growth Timeline (Latest Run)</h3>
                <canvas id="memoryTimelineChart"></canvas>
            </div>
        </div>

        <div class="chart-row">
            <div class="chart-card">
                <h3>üéØ Exit Reason Distribution</h3>
                <canvas id="exitReasonChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>üîê Policy Effectiveness Comparison</h3>
                <canvas id="policyChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <h3>üìã Recent Executions with ML Risk Assessment</h3>
            <table id="logs-table">
                <thead>
                    <tr>
                        <th>Program</th>
                        <th>Profile</th>
                        <th>Runtime</th>
                        <th>CPU %</th>
                        <th>Memory Growth</th>
                        <th>Exit Reason</th>
                        <th>Risk Assessment (Final)</th>
                        <th>ML Pattern Match (Info)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        let charts = {};

        async function fetchAndUpdate() {
            try {
                const [statsRes, analyticsRes] = await Promise.all([
                    fetch('/api/stats'),
                    fetch('/api/analytics')
                ]);

                const stats = await statsRes.json();
                const analytics = await analyticsRes.json();

                // Update summary cards
                document.getElementById('total-runs').textContent = stats.total_runs || 0;
                document.getElementById('violations').textContent = analytics.statistics?.syscall_violations || 0;
                document.getElementById('avg-cpu').textContent = (stats.avg_cpu || 0) + '%';
                document.getElementById('avg-mem').textContent = (stats.avg_mem || 0) + ' KB';

                // Timeline charts (latest run - take LAST element for most recent)
                if (stats.runs && stats.runs.length > 0) {
                    const latest = stats.runs[stats.runs.length - 1];
                    updateCPUTimeline(latest);
                    updateMemoryTimeline(latest);
                }

                // Exit reason pie chart
                updateExitReasonChart(stats.violations || {});

                // Policy comparison bar chart
                updatePolicyChart(analytics.statistics?.by_profile || {});

                // Table
                const tbody = document.querySelector('#logs-table tbody');
                tbody.innerHTML = '';
                (stats.runs || []).slice(0, 15).forEach(run => {
                    const tr = document.createElement('tr');
                    const predClass = run.prediction === 'Malicious' ? 'badge-malicious' :
                        run.prediction === 'Buggy' ? 'badge-buggy' :
                            run.prediction === 'Resource-Anomalous' ? 'badge-buggy' :
                                run.prediction === 'Ignored' ? 'badge-benign' : 'badge-benign';

                    // Memory Cell Logic
                    const peakMem = run.peak_memory_kb || 0;
                    const growthInv = run.memory_growth_kb || 0;

                    let memSubtext = `<div style="font-size:0.8em; color:#999">Stable</div>`;
                    if (run.memory_samples < 2) {
                        memSubtext = `<div style="font-size:0.8em; color:#999">Baseline only</div>`;
                    } else if (growthInv > 0) {
                        const color = growthInv > 5000 ? '#dc3545' : '#28a745';
                        memSubtext = `<div style="font-size:0.8em; font-weight:bold; color:${color}">+${growthInv} KB</div>`;
                    }

                    let memDisplay = `
                        <div>${peakMem.toLocaleString()} KB</div>
                        ${memSubtext}
                    `;

                    // Risk Cell Logic (Final Risk is Heuristic)
                    const finalRisk = run.final_risk || 'UNKNOWN';
                    let riskDisplay = `<span class="badge badge-benign">${finalRisk}</span>`;

                    if (finalRisk === 'HIGH' || finalRisk === 'CRITICAL' || finalRisk.includes('MEMORY_LEAK') || finalRisk === 'POLICY_VIOLATION') {
                        riskDisplay = `<span class="badge badge-malicious">${finalRisk}</span>`;
                    } else if (finalRisk === 'MEDIUM' || finalRisk.includes('CPU_HOG')) {
                        riskDisplay = `<span class="badge badge-buggy">${finalRisk}</span>`;
                    } else if (finalRisk === 'SHORT_LIVED_UTILITY') {
                        riskDisplay = `<span style="color:#666; font-style:italic" title="Insufficient telemetry">Short-lived (Benign)</span>`;
                    } else if (finalRisk === 'UNKNOWN') {
                        riskDisplay = `<span style="color:#999; font-style:italic">Unknown</span>`;
                    }

                    // ML Cell Logic (Informational)
                    let mlDisplay = `<span class="badge ${predClass}">${run.prediction || 'Pending'}</span>`;
                    if (run.prediction === 'Ignored') {
                        mlDisplay = `<span style="color:#999; font-style:italic">Ignored</span>`;
                    }

                    tr.innerHTML = `
                        <td>${run.program || 'N/A'}</td>
                        <td>${run.profile || 'N/A'}</td>
                        <td>${run.runtime_ms || 0}ms</td>
                        <td>${run.peak_cpu || run.cpu_usage_percent || 0}%</td>
                        <td>${memDisplay}</td>
                        <td>${run.exit_reason || 'N/A'}</td>
                        <td>${riskDisplay}</td>
                        <td>
                            <div style="margin-bottom:4px">${mlDisplay}</div>
                            <div style="font-size:0.8em; color:#666">Conf: ${run.confidence || 0}%</div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (e) {
                console.error('Error fetching data:', e);
            }
        }

        function updateCPUTimeline(run) {
            const ctx = document.getElementById('cpuTimelineChart');
            const timeline = run.timeline || {};
            const times = timeline.time_ms || [];
            const cpus = timeline.cpu_percent || [];

            if (charts.cpuTimeline) charts.cpuTimeline.destroy();

            charts.cpuTimeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: times.map(t => t + 'ms'),
                    datasets: [{
                        label: 'CPU %',
                        data: cpus,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true }
            });
        }

        function updateMemoryTimeline(run) {
            const ctx = document.getElementById('memoryTimelineChart');
            const timeline = run.timeline || {};
            const times = timeline.time_ms || [];
            const mems = timeline.memory_kb || [];

            if (charts.memTimeline) charts.memTimeline.destroy();

            charts.memTimeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: times.map(t => t + 'ms'),
                    datasets: [{
                        label: 'Memory KB',
                        data: mems,
                        borderColor: '#764ba2',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true }
            });
        }

        function updateExitReasonChart(violations) {
            const ctx = document.getElementById('exitReasonChart');

            if (charts.exitReason) charts.exitReason.destroy();

            charts.exitReason = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(violations),
                    datasets: [{
                        data: Object.values(violations),
                        backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true }
            });
        }

        function updatePolicyChart(byProfile) {
            const ctx = document.getElementById('policyChart');
            const profiles = Object.keys(byProfile);
            const counts = profiles.map(p => byProfile[p].count);

            if (charts.policy) charts.policy.destroy();

            charts.policy = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: profiles,
                    datasets: [{
                        label: 'Execution Count',
                        data: counts,
                        backgroundColor: '#667eea'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true }
            });
        }

        // Initial fetch and refresh every 2 seconds
        fetchAndUpdate();
        setInterval(fetchAndUpdate, 2000);
    </script>
</body>

</html>